<!DOCTYPE html><html lang="es"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Crear cuenta</title>
<link rel="stylesheet" href="main_styles.css">

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
  import { getAuth } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
  import { getFirestore } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";
</script>
<script type="module" src="firebase-config.js"></script>
<script type="module" src="assets/js/auth.js"></script>

<!-- UI básica + lógica de alta -->
<script type="module">
  import { auth, db } from "./assets/js/auth.js";
  import { createUserWithEmailAndPassword, updateProfile } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
  import { doc, setDoc, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

  // --- Clasificación rápida (mismo criterio: <5qt = Naboria, >=5qt = Nitaíno) ---
  function estimateOilCapacity({ displacement=2.5, cylinders=4, vehicleType="" } = {}){
    let oil = 4.5;
    const l = parseFloat(displacement)||2.5;
    if (l<2.0) oil=4.0; else if (l<2.5) oil=4.5; else if (l<3.0) oil=4.8; else if (l<3.5) oil=5.0; else if (l<4.0) oil=5.5; else oil=6.0;
    if (cylinders>=8) oil=Math.max(oil,5.5);
    if ((vehicleType||"").toLowerCase().match(/truck|suv|van/)) oil=Math.max(oil,5.0);
    return oil;
  }
  function classify(year, make, model){
    const m = (model||"").toLowerCase();
    let d=2.5, c=4, t="Passenger";
    if (m.match(/f-\d{3}|silverado|sierra|ram \d{4}|tundra|titan/)) { t="Truck"; d=5.0; c=8; }
    if (m.match(/tahoe|suburban|expedition|yukon|escalade|navigator|armada/)) { t="Large SUV"; d=5.3; c=8; }
    if (m.match(/explorer|pilot|highlander|traverse|atlas|telluride|palisade/)) { t="SUV"; d=3.5; c=6; }
    if (m.match(/rav4|cr-v|escape|rogue|equinox|tucson|sportage|compass/)) { t="Compact SUV"; d=2.5; c=4; }
    const oil = estimateOilCapacity({ displacement:d, cylinders:c, vehicleType:t });
    return { oil, tier: (oil<5.0 ? "Naboria" : "Nitaíno") };
  }

  // --- Poblado de años sencillos ---
  const yearSelect = document.addVehicle.year;
  const makeSelect = document.addVehicle.make;
  const modelSelect = document.addVehicle.model;
  const planDiv    = document.getElementById("plan");
  const curYear = new Date().getFullYear();
  for (let y=curYear; y>=curYear-30; y--) yearSelect.add(new Option(y,y));

  function updatePlan(){
    if (!yearSelect.value || !makeSelect.value || !modelSelect.value) { planDiv.textContent="—"; return; }
    const {oil,tier} = classify(yearSelect.value, makeSelect.value, modelSelect.value);
    planDiv.innerHTML = `${tier} <br><small>(${oil.toFixed(1)} qt)</small>`;
  }
  makeSelect.addEventListener('change', updatePlan);
  modelSelect.addEventListener('change', updatePlan);
  yearSelect.addEventListener('change', updatePlan);

  // --- Alta completa ---
  window.signup = async (e)=>{
    e.preventDefault();
    const email = sEmail.value.trim(), pass = sPass.value.trim();
    const nombre = sNombre.value.trim(), apellido = sApellido.value.trim();
    const direccion = sDireccion.value.trim();
    const year = yearSelect.value, make = makeSelect.value, model = modelSelect.value;
    const plate = sPlate.value.trim();
    if (!plate) { alert("La tablilla es obligatoria."); return; }

    try {
      const cred = await createUserWithEmailAndPassword(auth, email, pass);
      await updateProfile(cred.user, { displayName: `${nombre} ${apellido}` });

      await setDoc(doc(db, "users", cred.user.uid), {
        email, nombre, apellido, direccion, createdAt: Date.now()
      });

      const {oil, tier} = classify(year, make, model);
      await addDoc(collection(db, "users", cred.user.uid, "vehicles"), {
        year, make, model, plate, oilCapacity: oil, tier, createdAt: Date.now()
      });

      // puedes llevarlo luego al carrito/pago, por ahora va a su cuenta:
      location.href = "account.html";
    } catch(err){ alert("Error: " + err.message); }
  };
</script>
</head><body>
<nav class="top-nav">
  <div class="hamburger" onclick="toggleMenu()"><span></span><span></span><span></span></div>
  <div class="nav-left"><img src="Images/Logo_2.webp" alt="Agueybana Logo" class="logo" /></div>
  <div class="nav-center nav-buttons">
    <button onclick="location.href='index.html'">Inicio</button>
    <button onclick="location.href='subscripcion.html'">Suscripción</button>
    <button onclick="location.href='nosotros.html'">Sobre nosotros</button>
  </div>
  <div class="nav-right"></div>
</nav>

<main style="margin-top:12rem;display:flex;justify-content:center">
  <form name="addVehicle" onsubmit="signup(event)" class="vehicle-form" style="max-width:720px">
    <h2>Crear cuenta</h2>
    <div class="form-group"><label>Nombre</label><input id="sNombre" required></div>
    <div class="form-group"><label>Apellido</label><input id="sApellido" required></div>
    <div class="form-group"><label>Dirección física</label><input id="sDireccion" required></div>
    <div class="form-group"><label>Email</label><input id="sEmail" type="email" required></div>
    <div class="form-group"><label>Contraseña</label><input id="sPass" type="password" required></div>

    <h3 style="margin-top:1rem">Tu vehículo</h3>
    <div class="form-group"><label>Año</label><select id="year" required><option value="">Selecciona año</option></select></div>
    <div class="form-group"><label>Marca</label><input id="make" required placeholder="Toyota, Honda, Ford..."></div>
    <div class="form-group"><label>Modelo</label><input id="model" required placeholder="Corolla, Civic, F-150..."></div>
    <div class="form-group"><label>Tablilla (requerido)</label><input id="sPlate" required></div>
    <div class="form-group"><label>Plan asignado</label><div id="plan" class="plan-display">—</div></div>

    <button class="select-btn" style="margin-top:1rem">Crear cuenta</button>
  </form>
</main>
</body></html>
