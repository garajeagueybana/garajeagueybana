<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Crear cuenta</title>
  <link rel="stylesheet" href="main_styles.css" />
</head>
<body>
  <nav class="top-nav">
    <div class="nav-left"><img src="Images/Logo_2.webp" alt="Agueybana" class="logo" /></div>
    <div class="nav-center nav-buttons">
      <button onclick="location.href='index.html'">Inicio</button>
      <button onclick="location.href='subscripcion.html'">Suscripción</button>
      <button onclick="location.href='nosotros.html'">Sobre nosotros</button>
    </div>
  </nav>

  <main style="margin-top:12rem;display:flex;justify-content:center">
    <form id="signupForm" class="vehicle-form" style="max-width:720px">
      <h2>Crear cuenta</h2>

      <div class="form-group"><label>Nombre</label><input id="sNombre" required></div>
      <div class="form-group"><label>Apellido</label><input id="sApellido" required></div>
      <div class="form-group"><label>Dirección física</label><input id="sDireccion" required></div>
      <div class="form-group"><label>Email</label><input id="sEmail" type="email" required></div>
      <div class="form-group"><label>Contraseña</label><input id="sPass" type="password" required></div>

      <h3 style="margin-top:1rem">Tu vehículo</h3>
      <div class="form-group">
        <label>Año</label>
        <select id="year" required><option value="">Selecciona año</option></select>
      </div>
      <div class="form-group"><label>Marca</label><input id="makeEl" required placeholder="Toyota, Honda…"></div>
      <div class="form-group"><label>Modelo</label><input id="modelEl" required placeholder="Corolla, Civic…"></div>
      <div class="form-group"><label>Tablilla (requerido)</label><input id="plateEl" required></div>

      <button class="select-btn" style="margin-top:1rem">Crear cuenta</button>

      <!-- Panel de debug visible en la página -->
      <div id="debug" style="margin-top:1rem;font-size:.9rem;background:#111;color:#0f0;padding:1rem;border-radius:8px;display:none"></div>
    </form>
  </main>

  <!-- SDK base (carga única, no hace nada más aquí) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";
  </script>

  <!-- Config + Auth (inyecta botón de cuenta en la nav en otras páginas) -->
  <script type="module" src="firebase-config.js"></script>
  <script type="module" src="assets/js/auth.js"></script>

  <!-- Fix de imágenes (si lo estás usando) -->
  <script src="assets/js/images-fix.js"></script>

  <!-- Lógica de signup con modo debug -->
  <script type="module">
    import { auth, db } from "./assets/js/auth.js";
    import { createUserWithEmailAndPassword, updateProfile } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
    import { doc, setDoc, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

    // Clasificador simple (misma lógica que en subs.js) <5 qt = Naboria ; ≥5 = Nitaíno
    function classifyVehicle(year, make, model){
      const m=(model||"").toLowerCase();
      let oil=4.5;
      if (m.match(/f-\d{3}|silverado|sierra|ram \d{4}|tundra|titan|tahoe|suburban|yukon|escalade|explorer|pilot|highlander|traverse|telluride|palisade/)) oil=5.0;
      const tier = (oil<5.0) ? "Naboria" : "Nitaíno";
      return { oilCapacity: oil, type: tier };
    }

    // Poblar años
    const yearSel = document.getElementById('year');
    const now = new Date().getFullYear();
    for (let i=now; i>=now-30; i--) yearSel.add(new Option(i, i));

    const dbg = document.getElementById('debug');
    function log(msg){ dbg.style.display='block'; dbg.innerHTML += (dbg.innerHTML?'<br>':'') + msg; }

    document.getElementById('signupForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      dbg.innerHTML = ''; dbg.style.display='none';

      const email = sEmail.value.trim();
      const pass  = sPass.value.trim();
      const nombre = sNombre.value.trim();
      const apellido = sApellido.value.trim();
      const direccion = sDireccion.value.trim();
      const year = yearSel.value;
      const make = makeEl.value.trim();
      const model = modelEl.value.trim();
      const plate = plateEl.value.trim();

      if(!plate){ alert("La tablilla es obligatoria."); return; }

      try{
        log("Inicializando signup…");
        const cls = classifyVehicle(year, make, model);
        log(`Clasificación: ${cls.type} (${cls.oilCapacity.toFixed(1)} qt)`);

        // Crear usuario
        log("Creando usuario en Auth…");
        const cred = await createUserWithEmailAndPassword(auth, email, pass);
        log("Usuario creado.");

        // Perfil visible
        await updateProfile(cred.user, { displayName: `${nombre} ${apellido}` });
        log("Perfil actualizado.");

        // Documento base del usuario
        await setDoc(doc(db,"users",cred.user.uid), {
          email, nombre, apellido, direccion, createdAt: Date.now()
        });
        log("Documento /users creado.");

        // Vehículo
        await addDoc(collection(db,"users",cred.user.uid,"vehicles"), {
          year, make, model, plate,
          oilCapacity: cls.oilCapacity,
          tier: cls.type,
          createdAt: Date.now()
        });
        log("Vehículo guardado.");

        // Redirigir
        log("Redirigiendo a Mi cuenta…");
        location.href = "account.html";

      }catch(err){
        console.error(err);
        log("❌ ERROR: " + (err?.message || err));
        alert("Error al crear la cuenta: " + (err?.message || err));
      }
    });
  </script>
</body>
</html>
