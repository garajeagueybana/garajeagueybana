<!DOCTYPE html><html lang="es"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Crear cuenta</title>
<link rel="stylesheet" href="main_styles.css">
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
  import { getAuth } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
  import { getFirestore } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";
</script>
<script type="module" src="firebase-config.js"></script>
<script type="module" src="assets/js/auth.js"></script>
<script type="module" src="assets/js/subs.js"></script>
<script type="module">
  import { auth, db } from "./assets/js/auth.js";
  import { createUserWithEmailAndPassword, updateProfile } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
  import { doc, setDoc, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";
  import { classifyVehicle } from "./assets/js/subs.js";

  // poblar años
  window.addEventListener('DOMContentLoaded', ()=>{
    const y=document.getElementById('year'); const now=new Date().getFullYear();
    for (let i=now;i>=now-30;i--) y.add(new Option(i,i));
  });

  window.signup = async (e)=>{
    e.preventDefault();
    const email = sEmail.value.trim(), pass = sPass.value.trim();
    const nombre = sNombre.value.trim(), apellido = sApellido.value.trim();
    const direccion = sDireccion.value.trim();
    const year = year.value, make = makeEl.value.trim(), model = modelEl.value.trim();
    const plate = plateEl.value.trim(); if(!plate){ alert("La tablilla es obligatoria."); return; }

    // calcular plan
    const cls = await classifyVehicle(year, make, model);
    if (cls.type==='electric'){ alert("Vehículos eléctricos/híbridos no están disponibles en planes."); return; }
    const tier = cls.type; // "Naboria" o "Nitaíno"

    try{
      const cred = await createUserWithEmailAndPassword(auth, email, pass);
      await updateProfile(cred.user, { displayName: `${nombre} ${apellido}` });
      await setDoc(doc(db,"users",cred.user.uid), { email, nombre, apellido, direccion, createdAt: Date.now() });
      await addDoc(collection(db,"users",cred.user.uid,"vehicles"), { year, make, model, plate, oilCapacity: cls.oilCapacity, tier, createdAt: Date.now() });
      location.href = "account.html";
    }catch(err){ alert("Error: " + err.message); }
  };
</script>
</head><body>
<nav class="top-nav">
  <div class="nav-left"><img src="Images/Logo_2.webp" alt="Agueybana" class="logo"></div>
  <div class="nav-center nav-buttons">
    <button onclick="location.href='index.html'">Inicio</button>
    <button onclick="location.href='subscripcion.html'">Suscripción</button>
    <button onclick="location.href='nosotros.html'">Sobre nosotros</button>
  </div>
</nav>
<main style="margin-top:12rem;display:flex;justify-content:center">
  <form onsubmit="signup(event)" class="vehicle-form" style="max-width:720px">
    <h2>Crear cuenta</h2>
    <div class="form-group"><label>Nombre</label><input id="sNombre" required></div>
    <div class="form-group"><label>Apellido</label><input id="sApellido" required></div>
    <div class="form-group"><label>Dirección física</label><input id="sDireccion" required></div>
    <div class="form-group"><label>Email</label><input id="sEmail" type="email" required></div>
    <div class="form-group"><label>Contraseña</label><input id="sPass" type="password" required></div>

    <h3 style="margin-top:1rem">Tu vehículo</h3>
    <div class="form-group"><label>Año</label><select id="year" required><option value="">Selecciona año</option></select></div>
    <div class="form-group"><label>Marca</label><input id="makeEl" required placeholder="Toyota, Honda…"></div>
    <div class="form-group"><label>Modelo</label><input id="modelEl" required placeholder="Corolla, Civic…"></div>
    <div class="form-group"><label>Tablilla (requerido)</label><input id="plateEl" required></div>

    <button class="select-btn" style="margin-top:1rem">Crear cuenta</button>
  </form>
</main>
<script src="assets/js/images-fix.js"></script>
</body></html>
