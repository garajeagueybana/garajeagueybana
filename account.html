<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
  import { getFirestore, doc, getDoc, collection, getDocs, updateDoc } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";
  import { firebaseConfig } from "./firebase-config.js";

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const userInfoDiv = document.getElementById("user-info");
  const vehicleListDiv = document.getElementById("vehicle-list");

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      location.href = "login.html";
      return;
    }

    // Datos del usuario autenticado
    const userRef = doc(db, "users", user.uid);
    const userSnap = await getDoc(userRef);
    if (!userSnap.exists()) return;
    const data = userSnap.data();

    const isAdmin = data.role === "admin";
    userInfoDiv.innerHTML = `
      <p><b>Nombre:</b> ${data.nombre || ""} ${data.apellido || ""}</p>
      <p><b>Email:</b> ${user.email}</p>
      <p><b>Rol:</b> ${isAdmin ? "Administrador" : "Cliente"}</p>
      <button class="login-btn" onclick="logout()">Cerrar sesión</button>
    `;

    if (isAdmin) {
      renderAdminView();
    } else {
      renderClientView(user.uid);
    }
  });

  async function renderClientView(uid) {
    const vehRef = collection(db, "users", uid, "vehicles");
    const vehDocs = await getDocs(vehRef);
    vehicleListDiv.innerHTML = "<h3>Mis Vehículos</h3>";
    vehDocs.forEach((v) => {
      const d = v.data();
      const card = createVehicleCard(v.id, d, false);
      vehicleListDiv.appendChild(card);
    });
  }

  async function renderAdminView() {
    vehicleListDiv.innerHTML = "<h3>Panel del Administrador</h3>";
    const usersSnap = await getDocs(collection(db, "users"));
    for (const userDoc of usersSnap.docs) {
      const uid = userDoc.id;
      const userData = userDoc.data();
      const vehiclesSnap = await getDocs(collection(db, "users", uid, "vehicles"));
      vehiclesSnap.forEach((v) => {
        const d = v.data();
        const card = createVehicleCard(v.id, d, true, uid, userData);
        vehicleListDiv.appendChild(card);
      });
    }
  }

  function createVehicleCard(id, data, isAdmin, ownerId = "", ownerData = {}) {
    const card = document.createElement("div");
    card.classList.add("vehicle-card");
    card.innerHTML = `
      <strong>${data.year} ${data.make} ${data.model}</strong> — <i>${data.plate}</i> — <b>${data.tier}</b>
      ${isAdmin ? `<p style="font-size:.8rem;color:orange;">Propietario: ${ownerData.nombre || "Sin nombre"}</p>` : ""}
      <div class="vehicle-profile">
        <p><b>Estatus general:</b> <input type="range" min="0" max="100" value="${data.status || 100}" ${isAdmin ? "" : "disabled"} class="status-slider"></p>
        <p><b>Próxima visita:</b> <input type="date" value="${data.nextVisit || ""}" ${isAdmin ? "" : "disabled"} class="next-visit"></p>
        <div class="service-log">
          <p><b>Servicios:</b></p>
          <textarea class="service-list" rows="3" ${isAdmin ? "" : "disabled"}>${(data.services || []).join("\n")}</textarea>
        </div>
        ${isAdmin ? `<button class="select-btn save-btn">Guardar cambios</button>` : ""}
      </div>
    `;
    card.addEventListener("click", () => {
      const profile = card.querySelector(".vehicle-profile");
      profile.style.display = profile.style.display === "block" ? "none" : "block";
    });

    if (isAdmin) {
      const saveBtn = card.querySelector(".save-btn");
      saveBtn.addEventListener("click", async (e) => {
        e.stopPropagation();
        const slider = card.querySelector(".status-slider");
        const nextVisit = card.querySelector(".next-visit");
        const serviceList = card.querySelector(".service-list");
        await updateDoc(doc(db, "users", ownerId, "vehicles", id), {
          status: Number(slider.value),
          nextVisit: nextVisit.value || "Pendiente",
          services: serviceList.value.split("\n").filter(s => s.trim() !== "")
        });
        alert("✅ Cambios guardados correctamente");
      });
    }
    return card;
  }

  window.logout = () => signOut(auth).then(() => location.href = "index.html");
</script>
